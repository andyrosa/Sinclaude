<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sinclaude Sinclair Simulator</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Load constants first so they're available everywhere -->
    <script src="constants.js" onerror="handleScriptError('constants.js')"></script>
</head>

<body>
    <div class="top-row">
        <div class="section assembly-section">
            <div class="section-header-flex">
                <h2 id="assembly-section-title">1. Assembly Code Input</h2>
            </div>
            <div class="section-content">
                <div class="section-main section-main-flex">
                    <textarea id="assemblyInput" cols="80"
                        placeholder="Type or paste your Z80 assembly code here..." class="flex-textarea"></textarea>
                </div>
                <div class="section-controls">
                    <div class="controls">
                        <button onclick="sinclaude.clearAssembly()">Clear</button>
                        <button onclick="sinclaude.loadDefaultAssembly()">Load Default</button>
                        <button onclick="sinclaude.loadBenchmarkAssembly()">Load Benchmark</button>
                        <button onclick="sinclaude.loadSpaceInvaderAssembly()">Load Space Invader</button>
                        <button onclick="sinclaude.assembleAndRun()">Assemble and Run</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="section listing-section">
            <h2>2. Magazine Listing</h2>
            <div class="section-content">
                <div class="section-main">
                    <div id="machineCode"></div>
                </div>
            </div>
        </div>
        <div class="header-menu">
            <button class="header-menu-item" onpointerdown="expandAssemblyTextarea()" title="Expand Editor">‚§¢</button>
            <button class="header-menu-item" onclick="toggleMenu()" title="Menu">üçî</button>
            <div class="menu-dropdown" id="menuDropdown">
                <a href="#" onclick="showAbout(); return false;" class="menu-item">About</a>
                <a href="https://andyrosa.github.io/Sinclaude/" target="_blank" rel="noopener" class="menu-item">Docs</a>
                <a href="https://github.com/andyrosa/Sinclaude" target="_blank" rel="noopener" class="menu-item">Repo</a>
            </div>
        </div>
    </div>

    <div class="section console-section">
        <h2>3. Console Output</h2>
        <div class="section-content">
            <div class="section-main">
                <div id="console"></div>
            </div>
            <div class="section-controls">
                <div class="controls">
                    <button onclick="clearConsole()">Clear</button>
                </div>
            </div>
        </div>
    </div>

    <div class="section execution-section">
        <h2>4. Execution</h2>
        <div class="section-content">
            <div class="execution-left">
                <div id="screen"></div>
                <div id="keyboardStatus" class="keyboard-status"></div>
            </div>
            <div class="execution-controls">
                <div class="edit-toggle" onclick="toggleButtonEdit()"></div>
                <div class="controls game-buttons" id="gameButtons">
                    <!-- Buttons generated by JavaScript -->
                </div>
                <div class="controls" id="executionControls">
                    <!-- Dynamic buttons will be rendered here based on state -->
                </div>
                <div class="debug">
                    <div>PC: <span id="regPC">-</span></div>
                    <div>Op Code: <span id="currentInstruction">-</span></div>
                    <div>SP: <span id="regSP">-</span></div>
                    <div>A: <span id="regA">-</span></div>
                    <div>Zero: <span id="flagZ">-</span></div>
                    <div>Carry: <span id="flagC">-</span></div>
                    <div>BC: <span id="regBC">-</span></div>
                    <div>DE: <span id="regDE">-</span></div>
                    <div>HL: <span id="regHL">-</span></div>
                    <div>I/O Ports: <span id="ports">-</span></div>
                    <div>MIPS: <span id="mips">-</span></div>
                    <div>Refresh: <span id="refreshRate">-</span>Hz</div>
                    <div>Key: <span id="keyCodeCurrent">-</span></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Handle script loading errors
        function handleScriptError(scriptName) {
            console.error(`Failed to load script: ${scriptName}`);
            alert(`Error: Failed to load required script ${scriptName}. The simulator may not work correctly.`);
        }

        // Constants
        const LOCAL_HINT = "git";
        
        // Menu functionality
        function toggleMenu() {
            const dropdown = document.getElementById('menuDropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        }

        function expandAssemblyTextarea() {
            const textarea = document.getElementById('assemblyInput');
            if (textarea && window.sinclaude) {
                // Directly call the expansion method to avoid event conflicts
                window.sinclaude.expandElement('assemblyInput');
            }
        }

        function showAbout() {
            const versionInfo = getFormattedVersionInfo();
            
            let aboutText = "Sinclaude - Sinclair Z80 Simulator\n\nA web-based Z80 processor simulator for running Sinclair ZX Spectrum assembly code.";
            
            if (versionInfo) {
                aboutText += `\n\nVersion Info:\nBuild: ${versionInfo.buildNumber}\nDate: ${versionInfo.localBuildDate}\nCommit: ${versionInfo.shortCommit}`;
            }
            
            alert(aboutText);
            // Close menu after showing about
            document.getElementById('menuDropdown').style.display = 'none';
        }

        // Close menu when clicking outside
        document.addEventListener('pointerdown', function(event) {
            const headerMenu = document.querySelector('.header-menu');
            if (headerMenu && !headerMenu.contains(event.target)) {
                document.getElementById('menuDropdown').style.display = 'none';
            }
        });

        // Load version.js with fallback strategy: local first, then GitHub, then error
        (function () {
            function tryLoadGitHubVersion() {
                var githubVersionScript = document.createElement('script');
                githubVersionScript.src = 'https://andyrosa.github.io/Sinclaude/version.js?cb=' + Date.now();
                githubVersionScript.onload = function () {
                    loadSinclairScripts();
                };
                githubVersionScript.onerror = function () {
                    console.error('Failed to load version.js from both local and GitHub sources');
                    userMessageAboutBug('Unable to load version information from local or remote sources', 'Please check your internet connection or contact support.');
                    loadSinclairScripts();
                };
                document.head.appendChild(githubVersionScript);
            }

            // First try to load from local folder
            var localVersionScript = document.createElement('script');
            localVersionScript.src = 'version.js?cb=' + Date.now();
            localVersionScript.onload = function () {
                loadSinclairScripts();
            };
            localVersionScript.onerror = function () {
                tryLoadGitHubVersion();
            };
            document.head.appendChild(localVersionScript);
        })();

        function getFormattedVersionInfo() {
            if (typeof BUILD_VERSION_BY_YAML === 'undefined') {
                return null;
            }
            
            // Convert UTC timestamp to local time with error handling
            let localBuildDate = 'Unknown';
            if (BUILD_VERSION_BY_YAML.timestamp) {
                // Use the ISO timestamp which can be properly parsed
                const buildDate = new Date(BUILD_VERSION_BY_YAML.timestamp);
                if (!isNaN(buildDate.getTime())) {
                    localBuildDate = buildDate.toLocaleString();
                }
            } else if (BUILD_VERSION_BY_YAML.buildDate) {
                // Fallback to buildDate if timestamp is not available
                // Try to parse the formatted date string
                const buildDate = new Date(BUILD_VERSION_BY_YAML.buildDate);
                if (!isNaN(buildDate.getTime())) {
                    localBuildDate = buildDate.toLocaleString();
                }
            }
            
            return {
                buildNumber: BUILD_VERSION_BY_YAML.buildNumber || 'Unknown',
                localBuildDate: localBuildDate,
                shortCommit: BUILD_VERSION_BY_YAML.shortCommit || 'Unknown'
            };
        }

        function loadSinclairScripts() {
            var cacheBust = (typeof BUILD_VERSION_BY_YAML !== 'undefined' && BUILD_VERSION_BY_YAML.buildDate) ? BUILD_VERSION_BY_YAML.buildDate : Date.now();
            var scripts = [
                "console-utils.js",
                "z80_assembler.js",
                "z80_cpu_emulator.js",
                "z80_assembler_test.js",
                "z80_cpu_emulator_test.js",
                "default_asm.js",
                "benchmark_asm.js",
                "space_invader_asm.js",
                "simulator.js"
                // Note: initialization.js is loaded separately after all other scripts
            ];
            
            var scriptIndex = 0;
            
            function loadNextScript() {
                if (scriptIndex >= scripts.length) {
                    // All scripts loaded, now load initialization.js
                    loadInitializationScript();
                    return;
                }
                
                var src = scripts[scriptIndex];
                var script = document.createElement('script');
                script.src = src + '?cb=' + cacheBust;
                script.onload = function() {
                    scriptIndex++;
                    loadNextScript();
                };
                script.onerror = function() {
                    if (typeof userMessageAboutBug === 'function') {
                        userMessageAboutBug(`Failed to load script: ${src}`, `Script loading error for ${src}`);
                    } else {
                        console.error(`Failed to load script: ${src}`);
                        alert(`Error: Failed to load required script ${src}. The simulator may not work correctly.`);
                    }
                    // Continue loading even if one script fails
                    scriptIndex++;
                    loadNextScript();
                };
                document.body.appendChild(script);
            }
            
            function loadInitializationScript() {
                var script = document.createElement('script');
                script.src = 'initialization.js?cb=' + cacheBust;
                script.onerror = function() {
                    console.error('Failed to load initialization.js');
                    alert('Error: Failed to load initialization script. The simulator will not start.');
                };
                document.body.appendChild(script);
            }
            
            // Start loading scripts sequentially
            loadNextScript();
            
            // HACK: Visual ID for when this is being run locally by developer
            if (window.location.pathname.toLowerCase().includes(LOCAL_HINT)) {
                addDeveloperLegend();
            }
        }
        
        function addDeveloperLegend() {
            const assemblyTitle = document.getElementById('assembly-section-title');
            if (assemblyTitle) {
                const legend = document.createElement('span');
                legend.textContent = `${LOCAL_HINT}`;
                legend.style.position = 'absolute';
                legend.style.left = '50%';
                legend.style.transform = 'translateX(-50%)';
                legend.style.color = '#00ff00';
                legend.style.fontSize = '0.8em';
                legend.style.fontWeight = 'normal';
                legend.style.zIndex = Z_INDEX.BASE;
                legend.style.pointerEvents = 'none';
                
                // Make the parent h2 relatively positioned to contain the absolute positioned legend
                assemblyTitle.style.position = 'relative';
                assemblyTitle.appendChild(legend);
            }
        }
    </script>
</body>

</html>